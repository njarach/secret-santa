{
    skip_install_trust
    auto_https off

    {$CADDY_GLOBAL_OPTIONS}

    frankenphp {
       {$FRANKENPHP_CONFIG}

       worker {
          file ./public/index.php
          env APP_RUNTIME Runtime\FrankenPhpSymfony\Runtime
          {$FRANKENPHP_WORKER_CONFIG}
       }
    }
}

{$CADDY_EXTRA_CONFIG}

:8080 {
    log {
       {$CADDY_SERVER_LOG_OPTIONS}
       # Redact the authorization query parameter that can be set by Mercure
       format filter {
          request>uri query {
             replace authorization REDACTED
          }
       }
    }

    root /app/public
    encode zstd br gzip

    vulcain

    {$CADDY_SERVER_EXTRA_DIRECTIVES}

    # Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
    header ?Permissions-Policy "browsing-topics=()"

    @phpRoute {
       not path /.well-known/mercure*
       not file {path}
    }
    rewrite @phpRoute index.php

    @frontController path index.php
    php @frontController

    file_server {
       hide *.php
    }
}
